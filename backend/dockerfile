# ─── Build stage ──────────────────────────────────────────────────────────────
FROM node:24-alpine AS builder

WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .

# Generates Prisma client AND compiles TypeScript
RUN npm run build

# ─── Production stage ─────────────────────────────────────────────────────────
FROM node:24-alpine AS production

WORKDIR /app

COPY package*.json ./

# Install production deps, then add the Prisma CLI (needed for migrate deploy at startup)
RUN npm ci --only=production && npm install prisma

# Copy compiled app
COPY --from=builder /app/dist ./dist

# Copy Prisma artifacts
COPY --from=builder /app/node_modules/.prisma ./node_modules/.prisma
COPY --from=builder /app/prisma ./prisma

# Non-root user
RUN addgroup -g 1001 -S nodejs && adduser -S nestjs -u 1001
USER nestjs

EXPOSE 3001

# Run pending migrations, then start the server
CMD ["sh", "-c", "npx prisma migrate deploy && node dist/src/main.js"]
